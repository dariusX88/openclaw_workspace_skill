<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workspace Dashboard</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: system-ui, -apple-system, sans-serif;
    background: #f8f9fb;
    color: #1a1a2e;
    line-height: 1.5;
  }

  /* ── Header ────────────────────────────────────── */
  .header {
    background: #fff;
    border-bottom: 1px solid #e2e5ea;
    padding: 0.75rem 1.5rem 0;
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.75rem;
    padding-bottom: 0.75rem;
  }
  .header h1 {
    font-size: 1.25rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .header-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  /* ── Tabs ────────────────────────────────────────── */
  .tab-bar {
    display: flex;
    gap: 0;
    border-top: 1px solid #f3f4f6;
    margin: 0 -1.5rem;
    padding: 0 1.5rem;
  }
  .tab {
    padding: 0.6rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
    font-family: inherit;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .tab:hover { color: #374151; }
  .tab.active { color: #2563eb; border-bottom-color: #2563eb; }
  .tab .badge {
    background: #e5e7eb;
    color: #374151;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.1rem 0.4rem;
    border-radius: 9999px;
    min-width: 1.2rem;
    text-align: center;
  }
  .tab.active .badge { background: #dbeafe; color: #2563eb; }

  /* ── Controls ──────────────────────────────────── */
  select, .btn {
    font-family: inherit;
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background: #fff;
    cursor: pointer;
    transition: all 0.15s;
  }
  select:hover, .btn:hover { border-color: #93a3b8; }
  select:focus, .btn:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 2px rgba(37,99,235,0.15); }

  .btn-primary { background: #2563eb; color: #fff; border-color: #2563eb; font-weight: 500; }
  .btn-primary:hover { background: #1d4ed8; }
  .btn-danger { background: #fff; color: #dc2626; border-color: #fca5a5; }
  .btn-danger:hover { background: #fef2f2; border-color: #dc2626; }
  .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }
  .btn-ghost { background: none; border: none; color: #6b7280; cursor: pointer; padding: 0.3rem 0.5rem; font-family: inherit; font-size: 0.8rem; }
  .btn-ghost:hover { color: #1a1a2e; }
  .btn-back { background: none; border: 1px solid #d1d5db; border-radius: 6px; padding: 0.4rem 0.8rem; font-size: 0.85rem; cursor: pointer; font-family: inherit; color: #374151; display: inline-flex; align-items: center; gap: 0.3rem; }
  .btn-back:hover { background: #f3f4f6; }

  /* ── Main ──────────────────────────────────────── */
  .container { max-width: 1100px; margin: 0 auto; padding: 1.5rem; }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* ── Upload Zone ───────────────────────────────── */
  .upload-zone {
    border: 2px dashed #d1d5db;
    border-radius: 10px;
    padding: 2rem;
    text-align: center;
    margin-bottom: 1.5rem;
    transition: all 0.2s;
    background: #fff;
    cursor: pointer;
  }
  .upload-zone.drag-over { border-color: #2563eb; background: #eff6ff; }
  .upload-zone p { color: #6b7280; font-size: 0.9rem; }
  .upload-zone .icon { font-size: 2rem; margin-bottom: 0.5rem; }
  .upload-zone .hint { font-size: 0.8rem; color: #9ca3af; margin-top: 0.25rem; }

  .upload-progress { display: none; margin-top: 0.75rem; }
  .upload-progress .bar-track { height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
  .upload-progress .bar-fill { height: 100%; background: #2563eb; border-radius: 3px; width: 0%; transition: width 0.2s; }
  .upload-progress .bar-text { font-size: 0.8rem; color: #6b7280; margin-top: 0.25rem; }

  /* ── Stats Bar ─────────────────────────────────── */
  .stats { display: flex; gap: 1.5rem; margin-bottom: 1rem; font-size: 0.85rem; color: #6b7280; }
  .stats strong { color: #1a1a2e; }

  /* ── Table ─────────────────────────────────────── */
  .table-wrap { background: #fff; border: 1px solid #e2e5ea; border-radius: 10px; overflow: hidden; }
  table { width: 100%; border-collapse: collapse; }
  thead { background: #f9fafb; }
  th { text-align: left; padding: 0.75rem 1rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #6b7280; border-bottom: 1px solid #e2e5ea; }
  td { padding: 0.75rem 1rem; font-size: 0.875rem; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #f9fafb; }
  tr.clickable { cursor: pointer; }
  tr.clickable:hover td { background: #eff6ff; }

  .file-icon { margin-right: 0.4rem; }
  .filename { font-weight: 500; }
  .meta { color: #9ca3af; font-size: 0.8rem; }
  .workspace-tag { display: inline-block; background: #eff6ff; color: #2563eb; padding: 0.15rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
  .actions { display: flex; gap: 0.4rem; }

  /* ── Empty State ───────────────────────────────── */
  .empty { text-align: center; padding: 3rem 1rem; color: #9ca3af; }
  .empty .icon { font-size: 3rem; margin-bottom: 0.5rem; }

  /* ── Doc Detail ────────────────────────────────── */
  .doc-detail { background: #fff; border: 1px solid #e2e5ea; border-radius: 10px; padding: 2rem; }
  .doc-detail h2 { font-size: 1.5rem; margin-bottom: 0.25rem; }
  .doc-meta { font-size: 0.8rem; color: #9ca3af; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #f3f4f6; }
  .doc-blocks { line-height: 1.7; }
  .doc-blocks .block { margin-bottom: 1rem; }
  .doc-blocks .block-heading { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
  .doc-blocks .block-text { color: #374151; }
  .doc-blocks .block-list { padding-left: 1.5rem; }
  .doc-blocks .block-list li { margin-bottom: 0.25rem; }
  .doc-blocks .block-code { background: #1a1a2e; color: #e2e5ea; padding: 1rem; border-radius: 8px; font-family: 'SF Mono', Consolas, monospace; font-size: 0.85rem; overflow-x: auto; white-space: pre-wrap; }
  .doc-blocks .block-image img { max-width: 100%; border-radius: 8px; }
  .doc-blocks .block-table table { margin: 0; }
  .doc-blocks .block-table td, .doc-blocks .block-table th { padding: 0.5rem 0.75rem; border: 1px solid #e2e5ea; }

  /* ── Table Detail ──────────────────────────────── */
  .data-table-wrap { overflow-x: auto; }
  .data-table-wrap table { min-width: 100%; }
  .data-table-wrap th { white-space: nowrap; }
  .data-table-wrap .col-type { font-weight: 400; color: #9ca3af; font-size: 0.7rem; text-transform: lowercase; }

  /* ── Calendar Events ───────────────────────────── */
  .event-card { background: #fff; border: 1px solid #e2e5ea; border-radius: 10px; padding: 1rem 1.25rem; margin-bottom: 0.75rem; }
  .event-card .event-title { font-weight: 600; font-size: 1rem; }
  .event-card .event-time { font-size: 0.85rem; color: #2563eb; margin-top: 0.2rem; }
  .event-card .event-desc { font-size: 0.875rem; color: #6b7280; margin-top: 0.4rem; }

  /* ── Toast ─────────────────────────────────────── */
  .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; background: #1a1a2e; color: #fff; padding: 0.75rem 1.25rem; border-radius: 8px; font-size: 0.875rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 100; }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.error { background: #dc2626; }

  /* ── Responsive ────────────────────────────────── */
  @media (max-width: 700px) {
    .header { padding: 0.5rem 1rem 0; }
    .container { padding: 1rem; }
    td, th { padding: 0.5rem 0.6rem; font-size: 0.8rem; }
    .hide-mobile { display: none; }
    .doc-detail { padding: 1.25rem; }
    .tab { padding: 0.5rem 0.6rem; font-size: 0.8rem; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <h1>&#128188; Workspace</h1>
    <div class="header-actions">
      <select id="wsFilter">
        <option value="">All Workspaces</option>
      </select>
      <button class="btn btn-primary" id="uploadBtn" onclick="triggerUpload()">&#43; Upload</button>
      <button class="btn-ghost" onclick="logout()" title="Sign out">&#9211; Logout</button>
    </div>
  </div>
  <div class="tab-bar">
    <button class="tab active" data-tab="files" onclick="switchTab('files')">&#128196; Files <span class="badge" id="badge-files">0</span></button>
    <button class="tab" data-tab="docs" onclick="switchTab('docs')">&#128209; Docs <span class="badge" id="badge-docs">0</span></button>
    <button class="tab" data-tab="tables" onclick="switchTab('tables')">&#128202; Tables <span class="badge" id="badge-tables">0</span></button>
    <button class="tab" data-tab="calendar" onclick="switchTab('calendar')">&#128197; Calendar <span class="badge" id="badge-calendar">0</span></button>
  </div>
</div>

<div class="container">

  <!-- ═══ FILES TAB ═══ -->
  <div class="tab-content active" id="tab-files">
    <div class="upload-zone" id="dropZone" onclick="triggerUpload()">
      <div class="icon">&#128228;</div>
      <p>Drag &amp; drop files here, or click to browse</p>
      <p class="hint">Max 50 MB per file</p>
      <div class="upload-progress" id="uploadProgress">
        <div class="bar-track"><div class="bar-fill" id="uploadBar"></div></div>
        <div class="bar-text" id="uploadText">Uploading...</div>
      </div>
    </div>
    <input type="file" id="fileInput" hidden multiple>

    <div class="stats" id="fileStats"></div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>File</th>
            <th class="hide-mobile">Type</th>
            <th>Size</th>
            <th class="hide-mobile">Workspace</th>
            <th class="hide-mobile">Uploaded</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="fileList"></tbody>
      </table>
      <div class="empty" id="emptyFiles" style="display:none">
        <div class="icon">&#128194;</div>
        <p>No files yet. Upload something!</p>
      </div>
    </div>
  </div>

  <!-- ═══ DOCS TAB ═══ -->
  <div class="tab-content" id="tab-docs">
    <!-- List view -->
    <div id="docsListView">
      <div class="stats" id="docStats"></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th class="hide-mobile">Workspace</th>
              <th class="hide-mobile">Created</th>
              <th>Updated</th>
            </tr>
          </thead>
          <tbody id="docList"></tbody>
        </table>
        <div class="empty" id="emptyDocs" style="display:none">
          <div class="icon">&#128209;</div>
          <p>No documents yet. Ask OpenClaw to create one!</p>
        </div>
      </div>
    </div>
    <!-- Detail view -->
    <div id="docsDetailView" style="display:none">
      <button class="btn-back" onclick="showDocsList()">&#8592; Back to docs</button>
      <div class="doc-detail" id="docDetail" style="margin-top:1rem"></div>
    </div>
  </div>

  <!-- ═══ TABLES TAB ═══ -->
  <div class="tab-content" id="tab-tables">
    <!-- List view -->
    <div id="tablesListView">
      <div class="stats" id="tableStats"></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Table Name</th>
              <th class="hide-mobile">Workspace</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody id="tableList"></tbody>
        </table>
        <div class="empty" id="emptyTables" style="display:none">
          <div class="icon">&#128202;</div>
          <p>No tables yet. Ask OpenClaw to create one!</p>
        </div>
      </div>
    </div>
    <!-- Detail view -->
    <div id="tablesDetailView" style="display:none">
      <button class="btn-back" onclick="showTablesList()">&#8592; Back to tables</button>
      <div id="tableDetail" style="margin-top:1rem"></div>
    </div>
  </div>

  <!-- ═══ CALENDAR TAB ═══ -->
  <div class="tab-content" id="tab-calendar">
    <!-- List view -->
    <div id="calendarListView">
      <div class="stats" id="calStats"></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Calendar</th>
              <th class="hide-mobile">Workspace</th>
            </tr>
          </thead>
          <tbody id="calendarList"></tbody>
        </table>
        <div class="empty" id="emptyCalendars" style="display:none">
          <div class="icon">&#128197;</div>
          <p>No calendars yet. Ask OpenClaw to create one!</p>
        </div>
      </div>
    </div>
    <!-- Detail view -->
    <div id="calendarDetailView" style="display:none">
      <button class="btn-back" onclick="showCalendarsList()">&#8592; Back to calendars</button>
      <div id="calendarDetail" style="margin-top:1rem"></div>
    </div>
  </div>

</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
const API = '/browser/api';
let currentTab = 'files';

// Data stores
let allFiles = [];
let allDocs = [];
let allTables = [];
let allCalendars = [];
let workspaces = [];

// ── Init ────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', async () => {
  await loadWorkspaces();
  await loadAllData();
  setupDragDrop();
  document.getElementById('wsFilter').addEventListener('change', () => loadAllData());
  document.getElementById('fileInput').addEventListener('change', handleFileSelect);
});

// ── Tab Switching ───────────────────────────────────
function switchTab(tab) {
  currentTab = tab;
  // Update tab buttons
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
  // Update content
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  // Show/hide upload button (only for files tab)
  document.getElementById('uploadBtn').style.display = tab === 'files' ? '' : 'none';
  // Reset detail views
  if (tab === 'docs') showDocsList();
  if (tab === 'tables') showTablesList();
  if (tab === 'calendar') showCalendarsList();
}

// ── API Helpers ─────────────────────────────────────
async function api(path, opts = {}) {
  const res = await fetch(API + path, { credentials: 'same-origin', ...opts });
  if (res.status === 401) { window.location.href = '/browser'; return null; }
  if (!res.ok) {
    const err = await res.json().catch(() => ({ error: res.statusText }));
    throw new Error(err.error || 'Request failed');
  }
  return res.json();
}

// ── Load All Data ───────────────────────────────────
async function loadAllData() {
  const wsId = document.getElementById('wsFilter').value;
  const qs = wsId ? `?workspaceId=${wsId}` : '';

  // Load all in parallel
  const [filesData, docsData, tablesData, calendarsData] = await Promise.all([
    api('/files' + qs).catch(() => ({ files: [] })),
    api('/docs/pages' + qs).catch(() => ({ pages: [] })),
    api('/tables' + qs).catch(() => ({ tables: [] })),
    api('/calendars' + qs).catch(() => ({ calendars: [] })),
  ]);

  allFiles = filesData?.files || [];
  allDocs = docsData?.pages || [];
  allTables = tablesData?.tables || [];
  allCalendars = calendarsData?.calendars || [];

  renderFiles();
  renderDocs();
  renderTables();
  renderCalendars();
  updateBadges();
}

function updateBadges() {
  document.getElementById('badge-files').textContent = allFiles.length;
  document.getElementById('badge-docs').textContent = allDocs.length;
  document.getElementById('badge-tables').textContent = allTables.length;
  document.getElementById('badge-calendar').textContent = allCalendars.length;
}

// ── Load Workspaces ─────────────────────────────────
async function loadWorkspaces() {
  try {
    const data = await api('/workspaces');
    if (!data) return;
    workspaces = data.workspaces || [];
    const sel = document.getElementById('wsFilter');
    workspaces.forEach(ws => {
      const opt = document.createElement('option');
      opt.value = ws.id;
      opt.textContent = ws.name;
      sel.appendChild(opt);
    });
  } catch (e) {
    console.error('Failed to load workspaces:', e);
  }
}

// ═══════════════════════════════════════════════════
//  FILES
// ═══════════════════════════════════════════════════

function renderFiles() {
  const tbody = document.getElementById('fileList');
  const empty = document.getElementById('emptyFiles');
  const stats = document.getElementById('fileStats');

  if (allFiles.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    stats.innerHTML = '';
    return;
  }
  empty.style.display = 'none';

  const totalSize = allFiles.reduce((s, f) => s + Number(f.size_bytes || 0), 0);
  stats.innerHTML = `<span><strong>${allFiles.length}</strong> file${allFiles.length !== 1 ? 's' : ''}</span>
                     <span><strong>${fmtSize(totalSize)}</strong> total</span>`;

  tbody.innerHTML = allFiles.map(f => `
    <tr>
      <td>
        <span class="file-icon">${fileIcon(f.content_type)}</span>
        <span class="filename">${esc(f.filename)}</span>
      </td>
      <td class="hide-mobile meta">${esc(shortType(f.content_type))}</td>
      <td><span class="meta">${fmtSize(f.size_bytes)}</span></td>
      <td class="hide-mobile">
        ${f.workspace_name ? `<span class="workspace-tag">${esc(f.workspace_name)}</span>` : '<span class="meta">-</span>'}
      </td>
      <td class="hide-mobile meta">${fmtDate(f.created_at)}</td>
      <td>
        <div class="actions">
          <a href="${API}/files/${f.id}/download" class="btn btn-sm" title="Download">&#8615;</a>
          <button class="btn btn-sm btn-danger" onclick="deleteFile('${f.id}','${esc(f.filename)}')" title="Delete">&#10005;</button>
        </div>
      </td>
    </tr>
  `).join('');
}

function triggerUpload() {
  const wsId = document.getElementById('wsFilter').value;
  if (!wsId && workspaces.length > 0) { toast('Select a workspace first', true); return; }
  if (workspaces.length === 0) { toast('Create a workspace first (via API or OpenClaw)', true); return; }
  document.getElementById('fileInput').click();
}

function handleFileSelect(e) {
  const files = e.target.files;
  if (files.length) uploadFiles(files);
  e.target.value = '';
}

function setupDragDrop() {
  const zone = document.getElementById('dropZone');
  ['dragenter', 'dragover'].forEach(evt =>
    zone.addEventListener(evt, e => { e.preventDefault(); zone.classList.add('drag-over'); })
  );
  ['dragleave', 'drop'].forEach(evt =>
    zone.addEventListener(evt, e => { e.preventDefault(); zone.classList.remove('drag-over'); })
  );
  zone.addEventListener('drop', e => {
    const files = e.dataTransfer.files;
    if (files.length) uploadFiles(files);
  });
}

async function uploadFiles(fileList) {
  const wsId = document.getElementById('wsFilter').value;
  if (!wsId) { toast('Select a workspace first', true); return; }

  const progress = document.getElementById('uploadProgress');
  const bar = document.getElementById('uploadBar');
  const text = document.getElementById('uploadText');
  progress.style.display = 'block';

  let uploaded = 0;
  const total = fileList.length;

  for (const file of fileList) {
    text.textContent = `Uploading ${file.name} (${uploaded + 1}/${total})...`;
    bar.style.width = `${(uploaded / total) * 100}%`;
    try {
      const form = new FormData();
      form.append('file', file);
      form.append('workspaceId', wsId);
      await fetch(API + '/files?workspaceId=' + wsId, {
        method: 'POST', body: form, credentials: 'same-origin',
      }).then(r => {
        if (r.status === 401) { window.location.href = '/browser'; return; }
        if (!r.ok) throw new Error('Upload failed');
        return r.json();
      });
      uploaded++;
    } catch (e) { toast(`Failed to upload ${file.name}`, true); }
  }

  bar.style.width = '100%';
  text.textContent = `Done! ${uploaded} file${uploaded !== 1 ? 's' : ''} uploaded.`;
  toast(`Uploaded ${uploaded} file${uploaded !== 1 ? 's' : ''}`);
  setTimeout(() => { progress.style.display = 'none'; bar.style.width = '0%'; }, 2000);
  await loadAllData();
}

async function deleteFile(id, name) {
  if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
  try {
    await api('/files/' + id, { method: 'DELETE' });
    toast(`Deleted ${name}`);
    await loadAllData();
  } catch (e) { toast('Delete failed: ' + e.message, true); }
}

// ═══════════════════════════════════════════════════
//  DOCS
// ═══════════════════════════════════════════════════

function renderDocs() {
  const tbody = document.getElementById('docList');
  const empty = document.getElementById('emptyDocs');
  const stats = document.getElementById('docStats');

  if (allDocs.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    stats.innerHTML = '';
    return;
  }
  empty.style.display = 'none';
  stats.innerHTML = `<span><strong>${allDocs.length}</strong> document${allDocs.length !== 1 ? 's' : ''}</span>`;

  tbody.innerHTML = allDocs.map(d => `
    <tr class="clickable" onclick="openDoc('${d.id}')">
      <td>
        <span class="file-icon">&#128209;</span>
        <span class="filename">${esc(d.title || 'Untitled')}</span>
      </td>
      <td class="hide-mobile">
        ${d.workspace_name ? `<span class="workspace-tag">${esc(d.workspace_name)}</span>` : '<span class="meta">-</span>'}
      </td>
      <td class="hide-mobile meta">${fmtDate(d.created_at)}</td>
      <td><span class="meta">${fmtDate(d.updated_at || d.created_at)}</span></td>
    </tr>
  `).join('');
}

function showDocsList() {
  document.getElementById('docsListView').style.display = '';
  document.getElementById('docsDetailView').style.display = 'none';
}

async function openDoc(id) {
  try {
    const data = await api('/docs/pages/' + id);
    if (!data) return;
    const { page, blocks } = data;

    document.getElementById('docsListView').style.display = 'none';
    document.getElementById('docsDetailView').style.display = '';

    let html = `<h2>${esc(page.title || 'Untitled')}</h2>`;
    html += `<div class="doc-meta">${page.workspace_name ? `<span class="workspace-tag">${esc(page.workspace_name)}</span> &middot; ` : ''}Created ${fmtDate(page.created_at)}${page.updated_at ? ` &middot; Updated ${fmtDate(page.updated_at)}` : ''}</div>`;
    html += '<div class="doc-blocks">';
    for (const block of blocks) {
      html += renderBlock(block);
    }
    if (blocks.length === 0) {
      html += '<p class="meta">This page has no content blocks.</p>';
    }
    html += '</div>';
    document.getElementById('docDetail').innerHTML = html;
  } catch (e) {
    toast('Failed to load document: ' + e.message, true);
  }
}

function renderBlock(block) {
  const d = block.data || {};
  switch (block.type) {
    case 'heading':
      const level = d.level || 2;
      return `<div class="block"><h${level} class="block-heading">${esc(d.content || '')}</h${level}></div>`;
    case 'text':
      return `<div class="block"><p class="block-text">${esc(d.content || '')}</p></div>`;
    case 'list': {
      const items = d.items || (d.content ? d.content.split('\n') : []);
      if (items.length === 0) return '';
      return `<div class="block"><ul class="block-list">${items.map(i => `<li>${esc(typeof i === 'string' ? i : (i.text || ''))}</li>`).join('')}</ul></div>`;
    }
    case 'code':
      return `<div class="block"><pre class="block-code">${esc(d.content || d.code || '')}</pre></div>`;
    case 'image':
      const src = d.url || d.src || '';
      return src ? `<div class="block block-image"><img src="${esc(src)}" alt="${esc(d.alt || 'Image')}"></div>` : '';
    case 'table': {
      const rows = d.rows || [];
      if (rows.length === 0) return '';
      let t = '<div class="block block-table"><div class="table-wrap"><table>';
      if (d.headers) {
        t += '<thead><tr>' + d.headers.map(h => `<th>${esc(h)}</th>`).join('') + '</tr></thead>';
      }
      t += '<tbody>';
      for (const row of rows) {
        const cells = Array.isArray(row) ? row : Object.values(row);
        t += '<tr>' + cells.map(c => `<td>${esc(String(c))}</td>`).join('') + '</tr>';
      }
      t += '</tbody></table></div></div>';
      return t;
    }
    default:
      // Fallback: show raw JSON
      return `<div class="block"><p class="block-text"><em>[${esc(block.type)}]</em> ${esc(d.content || JSON.stringify(d))}</p></div>`;
  }
}

// ═══════════════════════════════════════════════════
//  TABLES
// ═══════════════════════════════════════════════════

function renderTables() {
  const tbody = document.getElementById('tableList');
  const empty = document.getElementById('emptyTables');
  const stats = document.getElementById('tableStats');

  if (allTables.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    stats.innerHTML = '';
    return;
  }
  empty.style.display = 'none';
  stats.innerHTML = `<span><strong>${allTables.length}</strong> table${allTables.length !== 1 ? 's' : ''}</span>`;

  tbody.innerHTML = allTables.map(t => `
    <tr class="clickable" onclick="openTable('${t.id}')">
      <td>
        <span class="file-icon">&#128202;</span>
        <span class="filename">${esc(t.name || 'Untitled')}</span>
      </td>
      <td class="hide-mobile">
        ${t.workspace_name ? `<span class="workspace-tag">${esc(t.workspace_name)}</span>` : '<span class="meta">-</span>'}
      </td>
      <td><span class="meta">${fmtDate(t.created_at)}</span></td>
    </tr>
  `).join('');
}

function showTablesList() {
  document.getElementById('tablesListView').style.display = '';
  document.getElementById('tablesDetailView').style.display = 'none';
}

async function openTable(id) {
  try {
    const data = await api('/tables/' + id);
    if (!data) return;
    const { table: tbl, columns, rows } = data;

    document.getElementById('tablesListView').style.display = 'none';
    document.getElementById('tablesDetailView').style.display = '';

    let html = `<div class="table-wrap" style="margin-bottom:1rem; padding:1rem;">
      <h2 style="font-size:1.25rem; margin-bottom:0.25rem;">&#128202; ${esc(tbl.name || 'Untitled')}</h2>
      <div class="doc-meta">${tbl.workspace_name ? `<span class="workspace-tag">${esc(tbl.workspace_name)}</span> &middot; ` : ''}${columns.length} column${columns.length !== 1 ? 's' : ''} &middot; ${rows.length} row${rows.length !== 1 ? 's' : ''}</div>
    </div>`;

    if (columns.length === 0) {
      html += '<div class="empty"><p>This table has no columns defined.</p></div>';
    } else {
      html += '<div class="data-table-wrap"><div class="table-wrap"><table><thead><tr>';
      html += '<th>#</th>';
      for (const col of columns) {
        html += `<th>${esc(col.name)} <span class="col-type">${esc(col.type)}</span></th>`;
      }
      html += '</tr></thead><tbody>';

      if (rows.length === 0) {
        html += `<tr><td colspan="${columns.length + 1}" style="text-align:center; color:#9ca3af; padding:2rem;">No rows yet</td></tr>`;
      } else {
        rows.forEach((row, i) => {
          html += '<tr>';
          html += `<td class="meta">${i + 1}</td>`;
          for (const col of columns) {
            const val = row.cells[col.id];
            html += `<td>${renderCellValue(val, col.type)}</td>`;
          }
          html += '</tr>';
        });
      }

      html += '</tbody></table></div></div>';
    }

    document.getElementById('tableDetail').innerHTML = html;
  } catch (e) {
    toast('Failed to load table: ' + e.message, true);
  }
}

function renderCellValue(val, colType) {
  if (val === null || val === undefined || val === '') return '<span class="meta">-</span>';
  // jsonb values might be wrapped
  const v = typeof val === 'object' && val !== null ? (val.value !== undefined ? val.value : JSON.stringify(val)) : val;
  switch (colType) {
    case 'boolean':
      return v === true || v === 'true' ? '<span style="color:#16a34a">&#10003;</span>' : '<span style="color:#dc2626">&#10007;</span>';
    case 'url':
      return `<a href="${esc(String(v))}" target="_blank" rel="noopener" style="color:#2563eb; text-decoration:underline;">${esc(String(v).substring(0, 40))}${String(v).length > 40 ? '...' : ''}</a>`;
    case 'date':
      return `<span>${fmtDate(v)}</span>`;
    case 'number':
      return `<span>${esc(String(v))}</span>`;
    default:
      return esc(String(v));
  }
}

// ═══════════════════════════════════════════════════
//  CALENDAR
// ═══════════════════════════════════════════════════

function renderCalendars() {
  const tbody = document.getElementById('calendarList');
  const empty = document.getElementById('emptyCalendars');
  const stats = document.getElementById('calStats');

  if (allCalendars.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    stats.innerHTML = '';
    return;
  }
  empty.style.display = 'none';
  stats.innerHTML = `<span><strong>${allCalendars.length}</strong> calendar${allCalendars.length !== 1 ? 's' : ''}</span>`;

  tbody.innerHTML = allCalendars.map(c => `
    <tr class="clickable" onclick="openCalendar('${c.id}', '${esc(c.name)}')">
      <td>
        <span class="file-icon">&#128197;</span>
        <span class="filename">${esc(c.name || 'Untitled')}</span>
      </td>
      <td class="hide-mobile">
        ${c.workspace_name ? `<span class="workspace-tag">${esc(c.workspace_name)}</span>` : '<span class="meta">-</span>'}
      </td>
    </tr>
  `).join('');
}

function showCalendarsList() {
  document.getElementById('calendarListView').style.display = '';
  document.getElementById('calendarDetailView').style.display = 'none';
}

async function openCalendar(id, name) {
  try {
    const data = await api('/calendars/' + id + '/events');
    if (!data) return;
    const events = data.events || [];

    document.getElementById('calendarListView').style.display = 'none';
    document.getElementById('calendarDetailView').style.display = '';

    let html = `<div class="table-wrap" style="margin-bottom:1rem; padding:1rem;">
      <h2 style="font-size:1.25rem; margin-bottom:0.25rem;">&#128197; ${esc(name || 'Calendar')}</h2>
      <div class="doc-meta">${events.length} event${events.length !== 1 ? 's' : ''}</div>
    </div>`;

    if (events.length === 0) {
      html += '<div class="empty"><div class="icon">&#128197;</div><p>No events in this calendar.</p></div>';
    } else {
      for (const ev of events) {
        html += `<div class="event-card">
          <div class="event-title">${esc(ev.title)}</div>
          <div class="event-time">&#128336; ${fmtDateTime(ev.start_ts)} &mdash; ${fmtDateTime(ev.end_ts)}</div>
          ${ev.description ? `<div class="event-desc">${esc(ev.description)}</div>` : ''}
        </div>`;
      }
    }

    document.getElementById('calendarDetail').innerHTML = html;
  } catch (e) {
    toast('Failed to load calendar: ' + e.message, true);
  }
}

// ═══════════════════════════════════════════════════
//  HELPERS
// ═══════════════════════════════════════════════════

function logout() {
  document.cookie = 'ws_session=; Path=/browser; Max-Age=0';
  window.location.href = '/browser';
}

function fmtSize(bytes) {
  const b = Number(bytes);
  if (b < 1024) return b + ' B';
  if (b < 1024 * 1024) return (b / 1024).toFixed(1) + ' KB';
  if (b < 1024 * 1024 * 1024) return (b / (1024 * 1024)).toFixed(1) + ' MB';
  return (b / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
}

function fmtDate(iso) {
  if (!iso) return '-';
  const d = new Date(iso);
  return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
}

function fmtDateTime(iso) {
  if (!iso) return '-';
  const d = new Date(iso);
  return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) +
    ' ' + d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
}

function shortType(ct) {
  if (!ct) return '-';
  const map = {
    'application/pdf': 'PDF', 'image/png': 'PNG', 'image/jpeg': 'JPEG', 'image/gif': 'GIF',
    'text/plain': 'Text', 'text/csv': 'CSV', 'application/json': 'JSON', 'application/zip': 'ZIP',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'Excel',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'Word',
  };
  return map[ct] || ct.split('/').pop();
}

function fileIcon(ct) {
  if (!ct) return '&#128196;';
  if (ct.startsWith('image/')) return '&#128247;';
  if (ct === 'application/pdf') return '&#128213;';
  if (ct.includes('spreadsheet') || ct === 'text/csv') return '&#128202;';
  if (ct.includes('word') || ct === 'text/plain') return '&#128209;';
  if (ct.includes('zip') || ct.includes('compressed')) return '&#128230;';
  if (ct.startsWith('video/')) return '&#127909;';
  if (ct.startsWith('audio/')) return '&#127925;';
  return '&#128196;';
}

function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function toast(msg, isError) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => { t.className = 'toast'; }, 3000);
}
</script>
</body>
</html>
